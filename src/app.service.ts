import { Injectable } from "@nestjs/common";
import { InjectModel } from "@nestjs/sequelize";
import { InjectBot } from "nestjs-telegraf";
import { Context, Markup, Telegraf } from "telegraf";
import { MyBotName } from "./app.constants";
import { User } from "./models/user.model";
import { mainmenu } from "./helpers/main_menu";
import { profilPart } from "./helpers/profil_part";
import { Driver } from "./models/driver.model";
import axios from "axios";

@Injectable()
export class AppService {
  constructor(
    @InjectModel(User) private userRepository: typeof User,
    @InjectModel(Driver) private driverRepository:typeof Driver,
    @InjectBot(MyBotName) private readonly bot: Telegraf<Context>
  ) {}
  async start(ctx: Context) {
    const user = await this.userRepository.findOne({
      where: { user_id: String(ctx.from.id) },
    });
    if (!user?.dataValues?.status) {
      if (!user) {
        await this.userRepository.create({
          user_id: String(ctx.from.id),
          first_name: ctx.from.first_name,
          last_name: ctx.from.last_name,
          username: ctx.from.username,
        });
      }
      await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
      await ctx.reply(
        `Assalomu alaykum! | –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\nTilni tanlang | –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:`,
        {
          parse_mode: "HTML",
          ...Markup.keyboard([
            ["üá∫üáø O'zbek tili","üá∑üá∫ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫"],
          ])
            .oneTime()
            .resize(),
        }
      );
    } else {
      if(user.last_state != 'finish') {
        await this.userRepository.update(
          { last_state: "lang" },
          { where: { user_id: String(ctx.from.id) } }
        );
      }

      await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
      if(user.user_lang == 'UZB') {
        return mainmenu(ctx,'UZB')
      } else {
        return mainmenu(ctx,'RUS')
      }
    }
  }

  async langUz(ctx:Context) {
    return this.saveLang(ctx,'UZB')
  }

  async langRu(ctx: Context) {
    return this.saveLang(ctx,'RUS')
  }
  async onContact(ctx: any) {
    const user = await this.userRepository.findOne({
      where: { user_id: String(ctx.from.id) },
    });
    if(user.user_lang == 'UZB') {
      if (!user) {
        await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
        await ctx.reply(`Iltimos, <b>start</b> tugmasini bosing! üëá`, {
          parse_mode: "HTML",
          ...Markup.keyboard([["/start"]])
            .oneTime()
            .resize(),
        });
      }
      if (ctx.message.contact.user_id !== ctx.from.id) {
        await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
        await ctx.reply(
          `Iltimos o'zingizni raqamingizni yuboring, <b>"Telefon raqamni yuborish"</b> tugmasini bosing! `,
          {
            parse_mode: "HTML",
            ...Markup.keyboard([
              [Markup.button.contactRequest("üìû Telefon raqamni yuborish")],
            ])
              .oneTime()
              .resize(),
          }
        );
      }
      await this.userRepository.update(
        {
          phone_number: ctx.message.contact.phone_number,
          status: true,
          last_state: "real_name",
        },
        { where: { user_id: String(ctx.from.id) } }
      );
      await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
      await ctx.reply(`<b>Sizga murojaat qilish uchun quyidagi ismingizni tanlang:</b>`, {
        parse_mode: "HTML",
        ...Markup.inlineKeyboard([Markup.button.callback(`Men ${ctx.from.first_name} ismini tanlayman`,'defaultsave')])
      });
      await ctx.replyWithHTML('Yoki haqiqiy ismingizni kiriting:')
    } else {
      if (ctx.message.contact.user_id !== ctx.from.id) {
        await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
        await ctx.reply(
          `–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä, <b>"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"</b> –Ω–∞–∂–∞—Ç—å –Ω–∞ –∫–Ω–æ–ø–∫—É! `,
          {
            parse_mode: "HTML",
            ...Markup.keyboard([
              [Markup.button.contactRequest("üìû –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞")],
            ])
              .oneTime()
              .resize(),
          }
        );
      }
      await this.userRepository.update(
        {
          phone_number: ctx.message.contact.phone_number,
          status: true,
          last_state: "real_name",
        },
        { where: { user_id: String(ctx.from.id) } }
      );
      await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
      await ctx.reply(`<b>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–µ –∏–º—è –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏:</b>`, {
        parse_mode: "HTML",
        ...Markup.inlineKeyboard([Markup.button.callback(`–Ø "${ctx.from.first_name}" –≤—ã–±–∏—Ä–∞—é –∏–º—è`,'defaultsave')])
      });
      await ctx.replyWithHTML('–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–µ –Ω–∞—Å—Ç–æ—è—â–µ–µ –∏–º—è:')
    }
  }

  async onStop(ctx: Context) {
    const user = await this.userRepository.findOne({
      where: { user_id: String(ctx.from.id) },
    });

    if (user?.dataValues.status) {
      await this.userRepository.update(
        { status: false, last_state: null },
        { where: { user_id: String(ctx.from.id) } }
      );

      await this.bot.telegram.sendChatAction(ctx.from.id, "typing");
      await ctx.reply(
        `Botdan chiqib ketdingiz, <b>start</b> tugmasini bosing! üëá`,
        {
          parse_mode: "HTML",
          ...Markup.keyboard([["/start"]])
            .oneTime()
            .resize(),
        }
      );
    } else {
      await ctx.reply(
        `Botdan mavjud emassiz, <b>start</b> tugmasini bosing! üëá`,
        {
          parse_mode: "HTML",
          ...Markup.keyboard([["/start"]])
            .oneTime()
            .resize(),
        }
      );
    }
  }

  async saveLang(ctx:Context, lang:String) {
    await User.update({
      user_lang: `${lang}`,
      last_state:'registration'
    },{
      where:{
        user_id: String(ctx.from.id)
      }
    })
    if(lang === 'UZB') {
      await ctx.reply(`Siz <b>¬´Lady Taxi¬ª</b> botidan ilk marta foydalanayotganingiz uchun,
  bir martalik ro'yxatdan o'tishingiz lozim!`,{
        parse_mode:'HTML',
        ...Markup.keyboard(["‚úÖ Ro'yxatdan o'tish"])
          .oneTime()
          .resize()
      })
    } else if(lang == 'RUS'){
        await ctx.reply(`–¢–∞–∫ –∫–∞–∫ –≤—ã –≤–ø–µ—Ä–≤—ã–µ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –±–æ—Ç–æ–º <b>¬´Lady Taxi¬ª</b>, 
–≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ–¥–∏–Ω —Ä–∞–∑!`,{
          parse_mode:'HTML',
          ...Markup.keyboard(["‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"])
            .oneTime()
            .resize()
        })
    }
  }
  async registration(ctx:Context,lang:String) {
    if (lang == 'UZB') {
      await ctx.reply(
        `Iltimos o'zingizni raqamingizni yuboring, <b>"Telefon raqamni yuborish"</b> tugmasini bosing! `,
        {
          parse_mode: "HTML",
          ...Markup.keyboard([
            [Markup.button.contactRequest("üìû Telefon raqamni yuborish")],
          ])
            .oneTime()
            .resize(),
        }
       );
      }
    else {
      await ctx.reply(
        ` –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏—à–ª–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä, –Ω–∞–∂–º–∏—Ç–µ <b>"–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞"</b>! `,
        {
          parse_mode: "HTML",
          ...Markup.keyboard([
            [Markup.button.contactRequest("üìû –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞")],
          ])
            .oneTime()
            .resize(),
        }
      );
    }
  }

  async saveName(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    await this.userRepository.update({
      real_name:`${user.username}`,
      last_state:'ads_phone_number'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply(`<b>Siz bilan bog'lanish uchun quyidagi telefon raqamingizni tanlang:</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback(`Men ${user.phone_number} raqamini tanlayman`, 'savedefaultphone')])
      })
      await ctx.replyWithHTML('Yoki boshqa ishlab turgan telefon raqam kiriting (namuna: 931234567):')
    } else {
      await ctx.reply(`<b>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏:</b>`, {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback(`—è –≤—ã–±–∏—Ä–∞—é ${user.phone_number} –Ω–æ–º–µ—Ä`, 'savedefaultphone')])
      })
      await ctx.replyWithHTML('–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ä–∞–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: 931234567):')
    }
  }

  async onMessage(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    const driver = await this.driverRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.last_state === "real_name") {
      if('text' in ctx.message) {
        await this.userRepository.update({
          real_name: `${ctx.message.text}`,
          last_state: 'ads_phone_number'
        }, {
          where: {
            user_id: `${ctx.from.id}`
          }
        })
      }
      if(user.user_lang == 'UZB') {
        await ctx.reply(`<b>Siz bilan bog'lanish uchun quyidagi telefon raqamingizni tanlang:</b>`, {
          parse_mode: 'HTML',
          ...Markup.inlineKeyboard([Markup.button.callback(`Men ${user.phone_number} raqamini tanlayman`, 'savedefaultphone')])
        })
        await ctx.reply('Yoki boshqa ishlab turgan telefon raqam kiriting (namuna: 931234567):')
      } else {
        await ctx.reply(`<b>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å—Å—è —Å –≤–∞–º–∏:</b>`, {
          parse_mode: 'HTML',
          ...Markup.inlineKeyboard([Markup.button.callback(`—è –≤—ã–±–∏—Ä–∞—é ${user.phone_number} –Ω–æ–º–µ—Ä`, 'savedefaultphone')])
        })
        await ctx.reply('–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–π —Ä–∞–±–æ—á–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–ø—Ä–∏–º–µ—Ä: 931234567):')
      }
    } else if(user.last_state === 'ads_phone_number'){
        if('text' in ctx.message) {
          await this.userRepository.update({
            ads_phone_number: `${ctx.message.text}`,
            last_state: 'finish'
          }, {
            where: {
              user_id: `${ctx.from.id}`
            }
          })
        }
      if(user.user_lang == 'UZB') {
        return mainmenu(ctx,'UZB')
      } else {
        return mainmenu(ctx,'RUS')
      }
    } else if(user.last_state == 'changeName') {
      const user = await this.userRepository.findOne({
        where:{
          user_id:`${ctx.from.id}`
        }
      })
      if('text' in ctx.message) {
        await this.userRepository.update({
          real_name:`${ctx.message.text}`,
          last_state:'finish'
        },{
          where:{
            user_id:`${ctx.from.id}`
          }
        })
      }
      if(user.user_lang == 'UZB') {
        if ('text' in ctx.message) {
          await ctx.replyWithHTML(`Ismingiz ${ctx.message.text} ga o'zgartirildi`,{
            parse_mode:'HTML',
            ...Markup.keyboard([["üöñ Taksi chaqirish üôã‚Äç‚ôÄÔ∏è", "üöö Yetkazib berish üôã‚Äç‚ôÄÔ∏è"], ["üôéüèº‚Äç‚ôÄÔ∏è Profil", "üè† Doimiy manzillar"]])
              .oneTime()
              .resize()
          })
        }
      } else {
        if('text' in ctx.message) {
          await ctx.replyWithHTML(`–í–∞—à–µ –∏–º—è –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ ${ctx.message.text}`,{
            parse_mode:'HTML',
            ...Markup.keyboard([["üöñ –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏ üôã‚Äç‚ôÄÔ∏è", "üöö –î–æ—Å—Ç–∞–≤–∫–∞ üôã‚Äç‚ôÄÔ∏è"],["üôéüèº‚Äç –ø—Ä–æ—Ñ–∏–ª—å", "üè† –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞"]])
              .oneTime()
              .resize()
          })
        }
      }
    } else if(user.last_state === 'changePhoneNumber'){
        const user = await this.userRepository.findOne({
          where:{
          user_id:`${ctx.from.id}`
            }
        })
      if('text' in ctx.message) {
        await this.userRepository.update({
          ads_phone_number:`${ctx.message.text}`,
          last_state:'finish'
        },{
          where:{
            user_id:`${ctx.from.id}`
          }
        })
      }
      if(user.user_lang == 'UZB') {
        if ('text' in ctx.message) {
          await ctx.replyWithHTML(`Telefon raqamingiz ${ctx.message.text} ga o'zgartirildi`,{
            parse_mode:'HTML',
            ...Markup.keyboard([["üöñ Taksi chaqirish üôã‚Äç‚ôÄÔ∏è", "üöö Yetkazib berish üôã‚Äç‚ôÄÔ∏è"], ["üôéüèº‚Äç‚ôÄÔ∏è Profil", "üè† Doimiy manzillar"]])
              .oneTime()
              .resize()
          })
        }
      } else {
      if('text' in ctx.message) {
        await ctx.replyWithHTML(`–≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ ${ctx.message.text}`,{
          parse_mode:'HTML',
          ...Markup.keyboard([["üöñ –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏ üôã‚Äç‚ôÄÔ∏è", "üöö –î–æ—Å—Ç–∞–≤–∫–∞ üôã‚Äç‚ôÄÔ∏è"],["üôéüèº‚Äç –ø—Ä–æ—Ñ–∏–ª—å", "üè† –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞"]])
            .oneTime()
            .resize()
        })
      }
    }
    } else if(user.last_state == 'car_number') {
      if('text' in ctx.message) {
        await this.driverRepository.update({
          car_number:`${ctx.message.text}`
        },{
          where: {
            user_id:`${ctx.from.id}`
          }
        })
        await this.userRepository.update({
          last_state:'tex-passport'
        },{
          where:{
            user_id:`${ctx.from.id}`
          }
        })
        if(user.user_lang == 'UZB') {
          await ctx.replyWithHTML("Mashinaning tex-passporti raqamini kiriting !")
        } else {
          await ctx.replyWithHTML("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –ø–∞—Å–ø–æ—Ä—Ç–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è !")
        }
      } else {
        if(user.user_lang == "UZB"){
          return mainmenu(ctx,'UZB');
        } else {
          return mainmenu(ctx,'RUS')
        }
      }
    } else if(user.last_state == 'tex-passport') {
      let data;
      if ('text' in ctx.message) {
        try {
          data = await (await axios.get(
            `https://api-dtp.yhxbb.uz/api/egov/open_data/info_car?format=json&plate_number=${driver.car_number}&tech_pass=${ctx.message.text}`
          )).data;
        } catch (error) {
          if(user.user_lang == 'UZB') {
            await ctx.reply('Texnik ruxsatnomangiz yoki mashina raqamingiz xato')
          } else {
            await ctx.reply("–í–∞—à–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–µ–≤–µ—Ä–Ω—ã")
          }
        }
        if(data) {
          await this.driverRepository.update({
            last_state: 'non-active',
            car_model: `${data.pModel}`,
            car_color: `${data.pVehicleColor}`,
            car_year: `${data.pYear}`
          }, {
            where: {
              user_id: `${ctx.from.id}`
            }
          })
          await this.userRepository.update({
            last_state:'non-active'
          },{
            where:{
              user_id:`${ctx.from.id}`
            }
          })
        } else {
          console.log("error");
        }
      }
      const newDriver = await this.driverRepository.findOne({
        where:{
          user_id:`${ctx.from.id}`
        }
      })
      await ctx.telegram.sendMessage(`${process.env.ADMIN_ID}`,`${newDriver.first_name}\n ${newDriver.last_name}\n ${newDriver.car_model}\n ${newDriver.car_number}\n ${newDriver.car_year}\n ${newDriver.user_id}`,{
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback("‚úÖ Tasdiqlayman",`verify=${ctx.from.id}`),Markup.button.callback("‚ùå Rad qilinsin",`otmen=${ctx.from.id}`)])
      });
      await ctx.replyWithHTML("Ma'lumotlaringiz <b>admin</b> ga yetkazildi. Admin ruxsat berishi bilan sizga activelik taqdim qilinadi")
    }
  }
  async defaultSavePhone(ctx:Context){
    const user = await this.userRepository.findOne({
      where:{
        user_id: `${ctx.from.id}`
      }
    })
    await this.userRepository.update({
      last_state:"finish"
    },{
      where: {
        user_id: `${ctx.from.id}`
      }
    })
    if(user.user_lang === 'UZB'){
      return mainmenu(ctx,'UZB')
    } else {
      return mainmenu(ctx,'RUS')
    }
  }

  async hearsProfil(ctx:Context,lang:String) {
    if(lang == 'UZB'){
      return profilPart(ctx,'UZB')
    } else {
      return profilPart(ctx,'RUS')
    }
  }

  async changeName(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    await this.userRepository.update({
      last_state: 'changeName'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB'){
      await ctx.reply('Ismingizni kiriting',{
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback('üôÖ‚Äç‚ôÄÔ∏è Bekor qilish','cancelling')])
      })
    } else if(user.user_lang == 'RUS') {
      await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è',{
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback('üôÖ‚Äç‚ôÄÔ∏è –û—Ç–º–µ–Ω–∞','cancelling')])
      })
    }
  }

  async phoneNumber(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id: `${ctx.from.id}`
      }
    })
    await this.userRepository.update({
      last_state:'changePhoneNumber'
    },{
      where:{
        user_id: `${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply(`Yangi telefon raqam kiriting`,{
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback('üôÖ‚Äç‚ôÄÔ∏è Bekor qilish','cancelling')])
      })
    } else {
      await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞',{
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback('üôÖ‚Äç‚ôÄÔ∏è –û—Ç–º–µ–Ω–∞','cancelling')])
      })
    }
  }
  async cancel(ctx:Context) {
    await this.userRepository.update({
      last_state:'finish'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang === 'UZB') {
        await ctx.replyWithHTML(`<b>Lady Taxy</b> bilan hammasi yanada oson ! `, {
          parse_mode: 'HTML',
          ...Markup.keyboard([["üöñ Taksi chaqirish üôã‚Äç‚ôÄÔ∏è", "üöö Yetkazib berish üôã‚Äç‚ôÄÔ∏è"], ["üôéüèº‚Äç‚ôÄÔ∏è Profil", "üè† Doimiy manzillar"]])
            .oneTime()
            .resize()
        })
    }else {
        await ctx.replyWithHTML(`–° <b>Lady Taxy</b> –≤—Å–µ –ø—Ä–æ—â–µ! `,{
          parse_mode:'HTML',
          ...Markup.keyboard([["üöñ –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏ üôã‚Äç‚ôÄÔ∏è", "üöö –î–æ—Å—Ç–∞–≤–∫–∞ üôã‚Äç‚ôÄÔ∏è"],["üôéüèº‚Äç –ø—Ä–æ—Ñ–∏–ª—å", "üè† –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞"]])
            .oneTime()
            .resize()
        })
    }
  }

  async changeLanguage(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    await ctx.reply('<b>Tilni tanlang/–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</b>',{
      parse_mode:'HTML',
      ...Markup.inlineKeyboard([
        [Markup.button.callback(`üá∫üáø O'zbek tili`,`uzblang`)],
        [Markup.button.callback(`üá∑üá∫ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫`,`rulang`)],
        [Markup.button.callback(`üôÖ‚Äç‚ôÄÔ∏è Bekor qilish/–û—Ç–º–µ–Ω–∞`,`cancelling`)]
      ])
    })
  }

  async changeRuLang(ctx: Context) {
    await this.userRepository.update({
      user_lang:'RUS'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    });
    await ctx.reply("<b>–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω!</b>",{
      parse_mode:'HTML',
      ...Markup.keyboard(["üë©‚Äçü¶± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"])
        .oneTime()
        .resize()
    })

  }
  async changeUzLang(ctx:Context) {
    await this.userRepository.update({
      user_lang:'UZB'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    await ctx.reply("<b>Til o'zgartirildi</b>",{
      parse_mode:'HTML',
      ...Markup.keyboard(["üë© Asosiy sahifa"])
        .oneTime()
        .resize()
    })
  }

  async toMainMenu(ctx:Context, lang:String) {
    if(lang === 'UZB'){
      await ctx.reply(`<b>üåπ Lady Taxy</b> to'gri tanlov`,{
        parse_mode:'HTML',
        ...Markup.keyboard([["üöñ Taksi chaqirish üôã‚Äç‚ôÄÔ∏è", "üöö Yetkazib berish üôã‚Äç‚ôÄÔ∏è"], ["üôéüèº‚Äç‚ôÄÔ∏è Profil", "üè† Doimiy manzillar"]])
          .oneTime()
          .resize()
      })
    } else {
      await ctx.reply(`<b>üåπ Lady Taxy </b> –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä`,{
        parse_mode:'HTML',
        ...Markup.keyboard([["üöñ –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏ üôã‚Äç‚ôÄÔ∏è", "üöö –î–æ—Å—Ç–∞–≤–∫–∞ üôã‚Äç‚ôÄÔ∏è"],["üôéüèº‚Äç –ø—Ä–æ—Ñ–∏–ª—å", "üè† –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞"]])
          .oneTime()
          .resize()
      })
    }
  }

  async ruleCallTaxy(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply('<b>Bu yerda ¬´Taksi chaqirish tartibi¬ª yoziladi</b>',{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë© Asosiy sahifa"])
          .oneTime()
          .resize()
      })
    } else {
      await ctx.reply(`<b>"–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤—ã–∑–æ–≤–∞ —Ç–∞–∫—Å–∏" –Ω–∞–ø–∏—Å–∞–Ω–∞ –∑–¥–µ—Å—å</b>`,{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë©‚Äçü¶± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"])
          .oneTime()
          .resize()
      })
    }
  }

  async ruleContract(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply('<b>Bu yerda ¬´Foydalanuvchi shartnomasi¬ª yoziladi</b>',{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë© Asosiy sahifa"])
          .oneTime()
          .resize()
      })
    } else {
      await ctx.reply(`<b>"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ" –Ω–∞–ø–∏—Å–∞–Ω–∞ –∑–¥–µ—Å—å</b>`,{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë©‚Äçü¶± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"])
          .oneTime()
          .resize()
      })
    }
  }

  async connectToStuff(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply('<b>Murojaat uchun </b>@abdulazizvr',{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë© Asosiy sahifa"])
          .oneTime()
          .resize()
      })
    } else {
      await ctx.reply('<b>–¥–ª—è —Å–≤—è–∑–∏ </b> @abdulazizvr',{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë©‚Äçü¶± –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"])
          .oneTime()
          .resize()
      })
    }
  }

  async mainPage(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(user.user_lang == 'UZB') {
      await ctx.reply(`<b>üåπ Lady Taxy</b> to'gri tanlov`,{
        parse_mode:'HTML',
        ...Markup.keyboard([["üöñ Taksi chaqirish üôã‚Äç‚ôÄÔ∏è", "üöö Yetkazib berish üôã‚Äç‚ôÄÔ∏è"], ["üôéüèº‚Äç‚ôÄÔ∏è Profil", "üè† Doimiy manzillar"]])
          .oneTime()
          .resize()
      })
    } else {
      await ctx.reply(`<b>üåπ Lady Taxy </b> –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä`,{
        parse_mode:'HTML',
        ...Markup.keyboard([["üöñ –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏ üôã‚Äç‚ôÄÔ∏è", "üöö –î–æ—Å—Ç–∞–≤–∫–∞ üôã‚Äç‚ôÄÔ∏è"],["üôéüèº‚Äç –ø—Ä–æ—Ñ–∏–ª—å", "üè† –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞"]])
          .oneTime()
          .resize()
      })
    }
  }

  async onDriver(ctx:Context) {
    const user = await this.userRepository.findOne({
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(!user) {
      await ctx.replyWithHTML("<b>Lady Taxi xizmatining haydovchi rejimiga xush kelibsiz</b>")
      await ctx.replyWithHTML("Haydovchi rejimiga o'tish uchun avval Mijoz rejimiga o'tib profilning Ism va Telefon ma'lumotlarini to'liq kiriting.")
    } else {
      await this.driverRepository.create({
        user_id:`${user.user_id}`,
        first_name:`${user.first_name}`,
        last_name:`${user.last_name}`,
        username: `${user.username}`,
        user_lang:`${user.user_lang}`,
        phone_number:`${user.phone_number}`
      })
      if(user.user_lang == 'UZB'){
      await ctx.reply("Lady Taxi xizmatining haydovchi rejimiga xush kelibsiz !")
      await ctx.reply("Lady Taxi xizmatida haydovchi sifatida ro'yxatdan o'tish uchun ¬´Ro'yxatdan o'tish¬ª tugmasini bosing.",{
        parse_mode:'HTML',
        ...Markup.keyboard(["üë©üèº‚Äçüíª Ro'yxatdan o'tish"])
          .oneTime()
          .resize()
      })
      } else {
        await ctx.reply('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ä–µ–∂–∏–º –¢–∞–∫—Å–∏—Å—Ç!')
        await ctx.reply("–ß—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≤–æ–¥–∏—Ç–µ–ª—è –≤ —Å–µ—Ä–≤–∏—Å–µ Lady Taxi, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª.",{
          parse_mode:'HTML',
          ...Markup.keyboard(["üë©üèº‚Äçüíª –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"])
            .oneTime()
            .resize()
        })
      }
    }
  }

  async registrationDriver(ctx:Context,lang:String) {
    await this.userRepository.update({
      last_state:'car_number'
    },{
      where:{
        user_id:`${ctx.from.id}`
      }
    })
    if(lang == 'UZB') {
      await ctx.reply('Avtomobil raqamini kiriting',{
        parse_mode:'HTML'
      })
    } else {
      await ctx.reply('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è',{
        parse_mode:'HTML'
      })
    }
  }

  async verifyDriver(ctx:Context) {
    let index;
    if('match' in ctx) {
      const message = ctx.match[0]
      index = message.split('=')[1]
    }
    const idUser = await this.driverRepository.findOne({
      where: {
        user_id:`${index}`
      }
    })
    console.log(typeof index);
    if(idUser.user_lang == 'UZB') {
      await ctx.telegram.sendMessage(`${index}`, "Admin sizga ruxsat berdi. Statusingizni tekshirib oling !", {
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback("‚òëÔ∏è Statusni tekshirish","checkDriverStatus")])
      })
    } else {
      await ctx.telegram.sendMessage(`${index}`, "–ê–¥–º–∏–Ω –¥–∞–ª –≤–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å !", {
        parse_mode:'HTML',
        ...Markup.inlineKeyboard([Markup.button.callback("‚òëÔ∏è –ü—Ä–æ–≤–µ—Ä—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ","checkDriverStatus")])
      })
    }
  }
}
